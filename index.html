<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ULTRA MILK</title>
<style>
  html, body {
    margin:0; padding:0; height:100%; overflow:hidden;
    background:#000;
    font-family: monospace, monospace;
    user-select:none;
  }
  canvas { display:block; }
  #titleScreen, #pauseMenu, #storyScreen {
    position: absolute;
    top:0; left:0; width:100%; height:100%;
    background: black;
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 99;
  }
  #titleScreen h1 {
    font-size: 4em;
    margin: 0;
    font-weight: bold;
  }
  #loadingMessage {
    margin-top: 1em;
    font-size: 1.3em;
  }
  #pauseMenu, #storyScreen {
    display:none;
  }
  #crosshair {
    position: absolute;
    top:50%; left:50%;
    width: 6px; height: 6px;
    margin-left: -3px; margin-top: -3px;
    background: white;
    z-index: 20;
  }
  #hud {
    position: absolute;
    bottom: 20px;
    width: 100%;
    display: flex;
    justify-content: space-between;
    color: white;
    padding: 0 20px;
    font-size: 14px;
    pointer-events: none;
    user-select:none;
    z-index: 10;
  }
  #weaponUI {
    background: rgba(0,0,0,0.5);
    padding: 8px 12px;
    border-radius: 8px;
  }
  #ultBarContainer {
    position: relative;
    width: 150px;
    height: 20px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    overflow: hidden;
  }
  #ultBar {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 0%;
    background: linear-gradient(90deg, #f8f8f8 0%, #c6f4ff 100%);
    border-radius: 10px;
    transition: width 0.3s ease;
  }
  #saveLoadUI {
    position: absolute;
    top: 10px;
    left: 10px;
    color: white;
    font-size: 14px;
    user-select:none;
    z-index: 10;
  }
  #saveLoadUI button {
    margin-right: 8px;
    background: #222;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
  }
  #pauseMenu button {
    margin-top: 1em;
    padding: 8px 16px;
    font-size: 16px;
    cursor: pointer;
    background: #222;
    border: none;
    color: white;
    border-radius: 6px;
  }
  #mobileControls {
    position: absolute;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    width: 220px;
    height: 80px;
    user-select:none;
    z-index: 10;
    display: none;
  }
  #mobileControls button {
    width: 60px;
    height: 60px;
    margin: 0 10px;
    font-size: 20px;
    border-radius: 30px;
    border: none;
    background: rgba(255 255 255 / 0.2);
    color: white;
  }
  #mobileJoystick {
    position: absolute;
    bottom: 20px;
    left: 20px;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: rgba(255 255 255 / 0.1);
    touch-action: none;
    user-select:none;
    z-index: 10;
  }
  #mobileJoystickThumb {
    position: absolute;
    top: 40px;
    left: 40px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
  }
</style>
</head>
<body>
  <div id="titleScreen">
    <h1>ULTRA MILK</h1>
    <div id="loadingMessage">Pasteurizing shaders…</div>
  </div>
  <div id="pauseMenu">
    <div>PAUSED</div>
    <button id="resumeBtn">Resume</button>
    <button id="quitBtn">Quit</button>
  </div>
  <div id="storyScreen" style="display:none;flex-direction:column;">
    <div id="storyText" style="max-width:600px;text-align:center; margin-bottom: 20px;"></div>
    <button id="continueStoryBtn">Continue</button>
  </div>
  <div id="crosshair"></div>
  <div id="hud">
    <div id="weaponUI">Weapon: Shotgun</div>
    <div id="ultBarContainer" title="Ultimate Charge">
      <div id="ultBar"></div>
    </div>
  </div>
  <div id="saveLoadUI" style="z-index:10;">
    <button id="saveBtn">Save</button>
    <button id="loadBtn">Load</button>
  </div>
  <div id="mobileControls">
    <button id="btnShoot">Fire</button>
    <button id="btnDash">Dash</button>
    <button id="btnUlt">ULT</button>
  </div>
  <div id="mobileJoystick">
    <div id="mobileJoystickThumb"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>
  <script>
(() => {
  // --- VARIABLES ---
  const loadingMessages = [
    "Pasteurizing shaders…",
    "Churning the shotgun…",
    "Milking the enemies…",
    "Homogenizing physics…",
    "Boiling the boss milk…"
  ];
  let loadingIndex = 0;
  const titleScreen = document.getElementById('titleScreen');
  const loadingMessageEl = document.getElementById('loadingMessage');
  const pauseMenu = document.getElementById('pauseMenu');
  const resumeBtn = document.getElementById('resumeBtn');
  const quitBtn = document.getElementById('quitBtn');
  const storyScreen = document.getElementById('storyScreen');
  const storyText = document.getElementById('storyText');
  const continueStoryBtn = document.getElementById('continueStoryBtn');
  const saveBtn = document.getElementById('saveBtn');
  const loadBtn = document.getElementById('loadBtn');
  const weaponUI = document.getElementById('weaponUI');
  const ultBar = document.getElementById('ultBar');
  const mobileControls = document.getElementById('mobileControls');
  const btnShoot = document.getElementById('btnShoot');
  const btnDash = document.getElementById('btnDash');
  const btnUlt = document.getElementById('btnUlt');
  const mobileJoystick = document.getElementById('mobileJoystick');
  const mobileJoystickThumb = document.getElementById('mobileJoystickThumb');

  // --- GAME STATE ---
  let gameStarted = false;
  let paused = false;
  let level = 1;
  let inStory = false;
  let ultCharge = 0;
  let keys = {};
  let weapons = ['pistol', 'shotgun', 'knife'];
  let currentWeaponIndex = 1; // start shotgun
  let currentWeapon = weapons[currentWeaponIndex];
  let killsForUlt = 0;

  // --- THREE.JS SETUP ---
  let scene, camera, renderer, clock;
  let player = { pos: new THREE.Vector3(0, 0, 0), speed: 0.12 };
  let enemies = [];
  let bullets = [];
  let ultActive = false;

  // --- LOADING SCREEN ---
  const loadingInterval = setInterval(() => {
    loadingMessageEl.textContent = loadingMessages[loadingIndex % loadingMessages.length];
    loadingIndex++;
  }, 1000);

  // --- INIT GAME ---
  window.addEventListener('load', () => {
    setTimeout(() => {
      clearInterval(loadingInterval);
      titleScreen.style.display = 'none';
      gameStarted = true;
      initThree();
      spawnLevel(level);
      animate();
      updateUI();
      setupInput();
      checkMobile();
    }, 4000);
  });

  // --- INITIALIZE THREE.JS ---
  function initThree() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 2, 5);
    camera.lookAt(0, 0, 0);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Lighting
    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
    scene.add(hemiLight);

    // Ground
    const groundGeo = new THREE.PlaneGeometry(100, 100);
    const groundMat = new THREE.MeshLambertMaterial({ color: 0xffffff });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    scene.add(ground);

    clock = new THREE.Clock();
  }

  // --- SPAWN ENEMIES FOR LEVEL ---
  function spawnLevel(levelNum) {
    clearEnemies();
    let enemyCount = 5 + levelNum * 2;
    // Add basic melee mobs
    for(let i=0; i<enemyCount; i++) {
      spawnEnemy('melee', randomPosInRange(20));
    }
    // Add 2 minibosses
    for(let i=0; i<2; i++) {
      spawnEnemy('miniboss', randomPosInRange(15));
    }
    // Add 1 boss on level 3+
    if(levelNum >= 3) {
      spawnEnemy('boss', new THREE.Vector3(0,0,-25));
    }
  }
  function clearEnemies() {
    enemies.forEach(e => scene.remove(e.mesh));
    enemies = [];
  }
  function spawnEnemy(type, pos) {
    const geometry = new THREE.BoxGeometry(type==='boss'?3:1, type==='boss'?4:2, type==='boss'?3:1);
    let color = 0xff0000;
    if(type==='miniboss') color = 0xff7700;
    else if(type==='boss') color = 0x990000;
    const material = new THREE.MeshLambertMaterial({ color });
    const mesh = new THREE.Mesh(geometry, material);
    mesh.position.copy(pos);
    scene.add(mesh);
    enemies.push({ type, mesh, health: type==='boss'? 20 : (type==='miniboss'? 5 : 1), speed: 0.04 + level*0.01, alive: true });
  }

  function randomPosInRange(range) {
    let x = (Math.random() - 0.5) * range * 2;
    let z = (Math.random() - 
