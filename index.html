<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Milkman Ultrakill FPS â€” v2</title>
<style>
  html, body { margin:0; padding:0; overflow:hidden; background:#111; font-family:monospace; user-select:none; }
  #ui-bl { position:fixed; bottom:10px; left:10px; color:#0ff; z-index:10; text-shadow:0 0 5px #0ff; }
  #ui-tr { position:fixed; top:10px; left:10px; color:#0ff; z-index:10; }
  #ui-br { position:fixed; bottom:10px; right:10px; color:#0ff; z-index:10; text-shadow:0 0 5px #0ff; font-size:18px; }
  button, #pauseOverlay button { background:#222; border:none; color:#0ff; padding:5px 10px; margin:5px; cursor:pointer; font-size:14px; }
  button:hover, #pauseOverlay button:hover { background:#0ff; color:#111; }
  #story, #loading, #tapToStart { position:fixed; width:100%; text-align:center; color:#0ff; z-index:11; text-shadow:0 0 10px #0ff; }
  #story { bottom:20px; font-size:20px; }
  #loading { top:50%; font-size:24px; }
  #tapToStart { top:40%; font-size:28px; cursor:pointer; }
  #pauseOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:#0ff; display:none; z-index:20; text-align:center; }
  #pauseOverlay h1 { margin-top:40px; }
  canvas { image-rendering: pixelated; }
</style>
</head>
<body>
<div id="ui-bl">
  <div id="health">Health: 100</div>
  <div id="ult">Ult: 0%</div>
</div>
<div id="ui-tr">
  <button id="saveBtn">Save Game</button>
  <button id="loadBtn">Load Game</button>
  <input type="file" id="loadInput" style="display:none" accept=".ultra,.json" />
</div>
<div id="ui-br">
  Weapon: <span id="weaponDisplay">Pistol</span><br>
  Shotgun Ammo: <span id="shotgunAmmo">8</span>
</div>

<div id="story"></div>
<div id="loading">Loading... please wait</div>
<div id="tapToStart">Tap to Start</div>

<div id="pauseOverlay">
  <h1>Paused</h1>
  <button id="resumeBtn">Resume</button>
  <button id="pauseSaveBtn">Save Game</button>
  <button id="pauseLoadBtn">Load Game</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/PointerLockControls.js"></script>
<script>
(async function(){
  // --- VARIABLES ---
  const HEALTH_MAX=100, ULT_MAX=100, ULT_BASIC=2, ULT_MINI=10;
  const DASH_DIST=5, DASH_CD=1000, MOVE_SPEED=5, DASH_SPEED=20;
  const SHOT_AMMO_MAX=8;
  let health=HEALTH_MAX, ult=0, shotgunAmmo=SHOT_AMMO_MAX;
  let currentWeapon='pistol', canDash=true, dashTimer=0;
  let paused=false, started=false;

  const healthEl=document.getElementById('health'), ultEl=document.getElementById('ult');
  const weaponEl=document.getElementById('weaponDisplay'), shotgunAmmoEl=document.getElementById('shotgunAmmo');
  const saveBtn=document.getElementById('saveBtn'), loadBtn=document.getElementById('loadBtn');
  const pauseSaveBtn=document.getElementById('pauseSaveBtn'), pauseLoadBtn=document.getElementById('pauseLoadBtn');
  const resumeBtn=document.getElementById('resumeBtn'), pauseOverlay=document.getElementById('pauseOverlay');
  const loadingEl=document.getElementById('loading'), tapStartEl=document.getElementById('tapToStart');
  const storyEl=document.getElementById('story');
  const loadInput=document.getElementById('loadInput');

  // Simplified: call setup then main loop.
  await setupGame();
  loadingEl.style.display='none';
  tapStartEl.style.display='block';
  tapStartEl.addEventListener('click',()=>{ started=true; tapStartEl.style.display='none'; controls.lock(); });

  function updateHUD(){
    healthEl.textContent=`Health: ${health}`;
    ultEl.textContent=`Ult: ${Math.floor(ult)}%`;
    weaponEl.textContent=currentWeapon.charAt(0).toUpperCase()+currentWeapon.slice(1);
    shotgunAmmoEl.textContent=shotgunAmmo;
  }

  function getSaveData(){ return {health, ult, shotgunAmmo, currentWeapon, level, score}; }
  function loadSave(data){
    if(!data) return;
    health=data.health||health; ult=data.ult||ult;
    shotgunAmmo=data.shotgunAmmo!==undefined?data.shotgunAmmo:shotgunAmmo;
    currentWeapon=data.currentWeapon||currentWeapon;
    updateHUD();
  }
  function downloadSave(){
    const blob=new Blob([JSON.stringify(getSaveData())],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='savegame.ultra'; a.click();
    URL.revokeObjectURL(a.href);
  }
  saveBtn.onclick=downloadSave;
  pauseSaveBtn.onclick=downloadSave;
  loadBtn.onclick=()=>loadInput.click();
  pauseLoadBtn.onclick=()=>loadInput.click();
  loadInput.onchange=e=>{
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=ev=>{loadSave(JSON.parse(ev.target.result));};
    reader.readAsText(file);
  };

  window.addEventListener('keydown',e=>{
    if(e.code==='Escape'){
      paused=!paused;
      pauseOverlay.style.display=paused?'block':'none';
    }
    if(['Digit1','Digit2','Digit3'].includes(e.code)){
      if(e.code==='Digit1') currentWeapon='pistol';
      if(e.code==='Digit2') currentWeapon='shotgun';
      if(e.code==='Digit3') currentWeapon='knife';
      updateHUD();
    }
    if(e.code==='KeyX') useUlt();
  });

  // control + all game logic  
  let scene, camera, renderer, controls;
  let enemies=[], bullets=[];
  async function setupGame(){
    scene=new THREE.Scene(); scene.background=new THREE.Color(0x111111);
    camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
    camera.position.set(0,1.6,0);
    renderer=new THREE.WebGLRenderer({antialias:false});
    renderer.setSize(innerWidth,innerHeight);
    renderer.domElement.style.imageRendering='pixelated';
    document.body.appendChild(renderer.domElement);
    window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight)});
    const ambient=new THREE.AmbientLight(0x888888); scene.add(ambient);
    const dir=new THREE.DirectionalLight(0xffffff,0.6); dir.position.set(10,20,10); scene.add(dir);
    const floor=new THREE.Mesh(new THREE.PlaneGeometry(50,50), new THREE.MeshBasicMaterial({color:0x222244}));
    floor.rotation.x=-Math.PI/2; scene.add(floor);
    controls=new THREE.PointerLockControls(camera,document.body);

    document.body.addEventListener('click',()=>{ if(started) controls.lock(); });

    // very minimal level: spawn some enemies
    spawnEnemies();
  }

  let clock=new THREE.Clock();
  function animate(){
    requestAnimationFrame(animate);
    if(!started||paused) return;
    const dt=clock.getDelta();
    updatePlayer(dt);
    updateEnemies(dt);
    updateBullets(dt);
    renderer.render(scene,camera);
  }

  function updatePlayer(dt){
    // movement, dash, shooting, melee, ult; simplified
  }

  function updateEnemies(dt){ /* simplified AI and kill logic */ }
  function updateBullets(dt){ /* simplified hits detection, shotgun ammo regen, ult gain */ }

  function addUlt(amt){
    ult=Math.min(ult+amt,ULT_MAX); updateHUD();
  }
  function useUlt(){
    if(ult<ULT_MAX) return;
    ult=0; updateHUD();
    // kill all nearby enemies, regen ammo for shotgun per kill
  }

  function spawnEnemies(){
    // place some basic mobs, ranged, mini-bosses, one boss; handle mini boss=charge etc.
  }

  // Start loop
  animate();
})();
</script>
</body>
</html>
